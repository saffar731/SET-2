<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safwat AI | Nexus</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="./Screenshot 2026-01-05 191642.png">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #000; color: #ececec; }
        .sidebar { background-color: #080808; border-right: 1px solid #1a1a1a; }
        .glass-input { background: rgba(18, 18, 18, 0.7); backdrop-filter: blur(20px); border: 1px solid #2a2a2a; }
        .logo-hybrid {
            position: relative; width: 40px; height: 40px;
            background: linear-gradient(135deg, #4f46e5, #9333ea);
            border-radius: 35% 65% 65% 35% / 30% 30% 70% 70%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 20px rgba(147, 51, 234, 0.3);
        }
        .logo-spark { color: white; font-size: 1.2rem; filter: drop-shadow(0 0 5px rgba(255,255,255,0.8)); }
        #splash { position: fixed; inset: 0; z-index: 100; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.6s ease; }
        /* Markdown Styling */
        .prose pre { background: #111 !important; padding: 1rem; border-radius: 0.75rem; border: 1px solid #222; margin: 1rem 0; overflow-x: auto; }
        .prose code { color: #818cf8; font-family: monospace; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <div id="splash">
        <div class="logo-hybrid animate-bounce mb-4"><i class="fa-solid fa-sparkles logo-spark"></i></div>
        <div class="w-40 h-0.5 bg-zinc-900 rounded-full overflow-hidden">
            <div class="h-full bg-indigo-500 w-1/4 animate-[loading_1.5s_infinite_ease-in-out]"></div>
        </div>
    </div>

    <aside class="w-72 sidebar flex flex-col hidden md:flex shrink-0">
        <div class="p-6">
            <div class="flex items-center gap-3 mb-10">
                <div class="logo-hybrid scale-90"><i class="fa-solid fa-sparkles logo-spark"></i></div>
                <div>
                    <h1 class="font-bold text-lg tracking-tight text-white">Safwat AI</h1>
                    <p class="text-[9px] uppercase tracking-widest text-zinc-500 font-bold">Hybrid Intelligence</p>
                </div>
            </div>
            <button onclick="createNewChat()" class="w-full bg-white text-black hover:bg-zinc-200 rounded-2xl py-3.5 px-4 text-sm font-bold transition-all flex items-center justify-center gap-3 mb-8 shadow-lg shadow-white/5">
                <i class="fa-solid fa-plus text-xs"></i> New Chat
            </button>
            <nav class="space-y-1 overflow-y-auto max-h-[50vh]" id="historyList"></nav>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative bg-gradient-to-b from-[#0a0a0a] to-[#000]">
        <div id="chatWindow" class="flex-1 overflow-y-auto px-4 py-8 md:p-16">
            <div id="emptyState" class="h-full flex flex-col items-center justify-center text-center">
                <div class="logo-hybrid w-20 h-20 scale-150 mb-12 shadow-indigo-500/40"><i class="fa-solid fa-sparkles text-3xl logo-spark"></i></div>
                <h1 class="text-5xl font-black text-white tracking-tighter mb-4">Ask me anything.</h1>
            </div>
        </div>

        <div class="p-6 md:pb-12">
            <div class="max-w-4xl mx-auto">
                <div class="glass-input rounded-[28px] flex items-center p-2.5 shadow-3xl">
                    <button onclick="document.getElementById('fileInput').click()" class="w-10 h-10 flex items-center justify-center text-zinc-500 hover:text-indigo-400 rounded-full">
                        <i class="fa-solid fa-paperclip text-lg"></i>
                    </button>
                    <input type="file" id="fileInput" class="hidden" onchange="uploadImage()">
                    <input type="text" id="userInput" onkeypress="if(event.key==='Enter') sendMessage()" placeholder="Type your prompt here..." class="flex-1 bg-transparent border-none outline-none px-4 text-md text-zinc-100 placeholder:text-zinc-600">
                    <button onclick="sendMessage()" class="bg-indigo-600 hover:bg-indigo-500 text-white w-12 h-12 rounded-full flex items-center justify-center">
                        <i class="fa-solid fa-arrow-up text-lg"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        let currentChatId = new URLSearchParams(window.location.search).get('chat');

        window.addEventListener('load', () => {
            if (!currentChatId) createNewChat();
            loadChatHistory();
            renderSidebar();
            setTimeout(() => { document.getElementById('splash').style.opacity = '0'; setTimeout(() => document.getElementById('splash').style.display = 'none', 600); }, 1000);
        });

        function createNewChat() {
            currentChatId = 'chat_' + Date.now();
            window.history.pushState({}, '', `?chat=${currentChatId}`);
            document.getElementById('chatWindow').innerHTML = '';
            showEmptyState();
        }

        function showEmptyState() {
            document.getElementById('chatWindow').innerHTML = `
                <div id="emptyState" class="h-full flex flex-col items-center justify-center text-center">
                    <div class="logo-hybrid w-20 h-20 scale-150 mb-12 shadow-indigo-500/40"><i class="fa-solid fa-sparkles text-3xl logo-spark"></i></div>
                    <h1 class="text-5xl font-black text-white tracking-tighter mb-4">Ask me anything.</h1>
                </div>`;
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            if(!message) return;
            
            input.value = '';
            addMessageToUI('user', message);
            saveToStorage('user', message);

            const loadingId = appendLoading();
            try {
                const res = await fetch('/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message})
                });
                const data = await res.json();
                document.getElementById(loadingId).remove();
                addMessageToUI('ai', data.reply);
                saveToStorage('ai', data.reply);
            } catch {
                document.getElementById(loadingId).remove();
                addMessageToUI('ai', "Error connecting to Safwat AI.");
            }
        }

        async function uploadImage() {
            const file = document.getElementById('fileInput').files[0];
            if(!file) return;

            const userPrompt = prompt("What would you like to know about this image?", "Analyze this image.");
            addMessageToUI('user', `[Uploaded Image: ${file.name}]\n\n${userPrompt}`);
            
            const loadingId = appendLoading();
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64 = e.target.result.split(',')[1];
                const res = await fetch('/upload', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({image_data: base64, mime_type: file.type, message: userPrompt})
                });
                const data = await res.json();
                document.getElementById(loadingId).remove();
                addMessageToUI('ai', data.reply);
                saveToStorage('ai', data.reply);
            };
            reader.readAsDataURL(file);
        }

        function addMessageToUI(sender, text) {
            document.getElementById('emptyState')?.remove();
            const win = document.getElementById('chatWindow');
            const isUser = sender === 'user';
            const div = document.createElement('div');
            div.className = `flex mb-10 ${isUser ? 'justify-end' : 'justify-start'}`;
            
            // Render markdown for AI responses
            const content = isUser ? text : marked.parse(text);

            div.innerHTML = `
                <div class="max-w-[85%] md:max-w-[70%] flex gap-5 ${isUser ? 'flex-row-reverse text-right' : ''}">
                    <div class="w-10 h-10 rounded-2xl flex-shrink-0 flex items-center justify-center ${isUser ? 'bg-zinc-800' : 'logo-hybrid'}">
                        <i class="fa-solid ${isUser ? 'fa-user' : 'fa-sparkles'} text-xs ${isUser ? 'text-zinc-500' : 'logo-spark'}"></i>
                    </div>
                    <div class="space-y-2 overflow-hidden">
                        <p class="text-[10px] font-black uppercase tracking-widest text-zinc-500">${isUser ? 'You' : 'Safwat AI'}</p>
                        <div class="prose prose-invert text-md leading-relaxed ${isUser ? 'text-indigo-100' : 'text-zinc-200'}">
                            ${content}
                        </div>
                    </div>
                </div>`;
            win.appendChild(div);
            win.scrollTo({top: win.scrollHeight, behavior: 'smooth'});
            hljs.highlightAll();
        }

        function saveToStorage(sender, text) {
            let history = JSON.parse(localStorage.getItem('safwat_history') || '{}');
            if (!history[currentChatId]) history[currentChatId] = [];
            history[currentChatId].push({sender, text});
            localStorage.setItem('safwat_history', JSON.stringify(history));
            renderSidebar();
        }

        function loadChatHistory() {
            let history = JSON.parse(localStorage.getItem('safwat_history') || '{}');
            if (history[currentChatId]) {
                document.getElementById('emptyState')?.remove();
                history[currentChatId].forEach(msg => addMessageToUI(msg.sender, msg.text));
            }
        }

        function renderSidebar() {
            const list = document.getElementById('historyList');
            let history = JSON.parse(localStorage.getItem('safwat_history') || '{}');
            list.innerHTML = '<p class="text-[10px] font-bold text-zinc-600 uppercase tracking-widest px-3 mb-3">Recent history</p>';
            Object.keys(history).reverse().forEach(id => {
                const firstMsg = history[id][0]?.text.substring(0, 25) || "New Chat";
                list.innerHTML += `
                    <div onclick="window.location.href='?chat=${id}'" class="p-3 rounded-xl hover:bg-zinc-900 cursor-pointer text-xs ${id === currentChatId ? 'bg-zinc-900 text-white' : 'text-zinc-500'} truncate">
                        <i class="fa-regular fa-message mr-2"></i> ${firstMsg}...
                    </div>`;
            });
        }

        function appendLoading() {
            const id = 'l-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex gap-5 mb-10 opacity-50";
            div.innerHTML = `<div class="w-10 h-10 rounded-2xl bg-zinc-900 flex items-center justify-center animate-pulse"><i class="fa-solid fa-ellipsis text-zinc-700"></i></div>`;
            document.getElementById('chatWindow').appendChild(div);
            return id;
        }
    </script>
</body>
</html>